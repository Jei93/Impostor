<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>THE IMPOSTOR - IAs Reales</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700;800&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root { --color-cyan: #00f5ff; --color-magenta: #ff2d95; --color-yellow: #ffe135; --color-green: #39ff14; --color-dark: #050508; --color-panel: #0d0d14; }
        body { font-family: 'Inter', sans-serif; background: var(--color-dark); color: #fff; min-height: 100vh; overflow-x: hidden; }
        .font-display { font-family: 'Space Grotesk', sans-serif; }
        .bg-animated { position: fixed; inset: 0; z-index: -1; background: radial-gradient(circle at 50% 50%, rgba(20,20,30,1) 0%, rgba(5,5,8,1) 100%); }
        /* Efectos Neon y Glitch */
        .glitch { animation: glitch-pulse 3s infinite; position: relative; }
        @keyframes glitch-pulse { 0%, 100% { text-shadow: 2px 2px 0px var(--color-magenta), -2px -2px 0px var(--color-cyan); } 50% { text-shadow: -2px 2px 0px var(--color-magenta), 2px -2px 0px var(--color-cyan); } }
        .card { background: rgba(20, 20, 30, 0.6); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; transition: transform 0.2s; }
        .card:hover { border-color: var(--color-cyan); }
        .avatar { width: 80px; height: 80px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 24px; position: relative; }
        .avatar.civilian { border: 2px solid var(--color-cyan); color: var(--color-cyan); background: rgba(0, 245, 255, 0.1); box-shadow: 0 0 15px rgba(0, 245, 255, 0.2); }
        .avatar.impostor { border: 2px solid var(--color-magenta); color: var(--color-magenta); background: rgba(255, 45, 149, 0.1); box-shadow: 0 0 15px rgba(255, 45, 149, 0.2); }
        .avatar.unknown { border: 2px solid #666; color: #aaa; background: rgba(255,255,255,0.05); }
        .btn { padding: 16px 32px; border-radius: 12px; font-weight: bold; cursor: pointer; transition: all 0.3s; font-family: 'Space Grotesk'; text-transform: uppercase; letter-spacing: 1px; }
        .btn-primary { background: var(--color-cyan); color: #000; box-shadow: 0 0 20px rgba(0, 245, 255, 0.4); border: none; }
        .btn-primary:hover { transform: scale(1.05); background: #fff; }
        .btn-secondary { background: transparent; border: 2px solid rgba(255,255,255,0.2); color: #fff; }
        .btn-secondary:hover { border-color: var(--color-cyan); color: var(--color-cyan); }
        .screen { display: none; min-height: 100vh; flex-direction: column; padding: 20px; animation: fadeIn 0.5s ease-out; }
        .screen.active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Chat y Logs */
        .typing-indicator span { display: inline-block; width: 6px; height: 6px; background: var(--color-cyan); border-radius: 50%; margin: 0 2px; animation: bounce 1.4s infinite; }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; } .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        
        .debug-console { font-family: 'Courier New', monospace; font-size: 12px; color: #aaa; max-height: 150px; overflow-y: auto; background: #000; padding: 10px; border-radius: 8px; border: 1px solid #333; }
        .debug-entry { margin-bottom: 4px; border-left: 2px solid #333; padding-left: 8px; }
    </style>
</head>
<body>
    <div class="bg-animated"></div>

    <div id="screen-start" class="screen active justify-center items-center text-center">
        <h1 class="font-display text-7xl md:text-9xl font-black mb-2 glitch" data-text="IMPOSTOR">IMPOSTOR</h1>
        <p class="text-xl md:text-2xl text-gray-400 mb-8 tracking-widest">DETECTA AL INFILTRADO</p>
        
        <div class="flex flex-col md:flex-row gap-6 w-full max-w-2xl">
            <button onclick="game.startHumanMode()" class="btn btn-primary flex-1">
                üéÆ Jugar como Humano
            </button>
            <button onclick="game.startSpectatorMode()" class="btn btn-secondary flex-1">
                üëÅÔ∏è Modo Espectador (IA vs IA)
            </button>
        </div>
        
        <div class="mt-8 text-sm text-gray-500 max-w-md">
            <p>‚ÑπÔ∏è Este juego utiliza IAs reales (Pollinations API). Las respuestas pueden tardar unos segundos mientras "piensan".</p>
        </div>
    </div>

    <div id="screen-lobby" class="screen items-center pt-20">
        <h2 class="font-display text-4xl mb-8">Conectando IAs...</h2>
        <div id="lobby-grid" class="grid grid-cols-1 md:grid-cols-5 gap-4 w-full max-w-6xl">
            </div>
        <div class="mt-12">
            <div class="typing-indicator"><span></span><span></span><span></span></div>
        </div>
    </div>

    <div id="screen-game" class="screen max-w-7xl mx-auto w-full">
        <div class="flex justify-between items-center mb-6">
            <div class="bg-white/10 px-4 py-2 rounded-lg font-mono">RONDA <span id="round-num" class="text-cyan-400">1</span>/3</div>
            <div id="phase-display" class="font-bold text-lg tracking-wider">FASE DE DESCRIPCI√ìN</div>
        </div>

        <div class="flex flex-col lg:flex-row gap-6 h-full">
            <div class="flex-1 flex flex-col">
                <div class="card p-8 flex-1 flex flex-col items-center justify-center text-center min-h-[400px] relative">
                    
                    <div id="secret-info" class="absolute top-4 left-4 text-left hidden">
                        <p class="text-xs text-gray-400 uppercase">Tu Rol</p>
                        <p id="player-role-display" class="font-bold text-xl mb-2"></p>
                        <p class="text-xs text-gray-400 uppercase">Tu Pista</p>
                        <p id="player-word-display" class="font-bold text-2xl text-cyan-400"></p>
                    </div>

                    <div id="active-avatar-container" class="mb-6 scale-125 transition-all">
                        <div id="main-avatar" class="avatar civilian">IA</div>
                    </div>
                    
                    <h3 id="main-name" class="text-2xl font-bold mb-2">IA-1</h3>
                    <div id="typing-status" class="h-8 text-cyan-400 font-mono text-sm mb-4">Pensando respuesta...</div>
                    
                    <div id="speech-bubble" class="bg-white/5 border border-white/10 p-6 rounded-2xl max-w-lg w-full min-h-[100px] flex items-center justify-center relative">
                        <p id="speech-text" class="text-xl md:text-2xl font-display">...</p>
                    </div>

                    <div id="human-input-area" class="hidden w-full max-w-md mt-6">
                        <input type="text" id="human-input" class="w-full bg-black/50 border border-cyan-500 rounded-lg p-4 text-center text-white outline-none mb-4" placeholder="Escribe tu descripci√≥n (1-2 palabras)..." maxlength="30">
                        <button onclick="game.submitHumanMove()" class="btn btn-primary w-full">ENVIAR</button>
                    </div>
                </div>

                <div id="debug-panel" class="mt-4 hidden">
                    <p class="text-xs text-gray-500 mb-1">üß† Pensamientos de la IA (Debug)</p>
                    <div id="debug-log" class="debug-console"></div>
                </div>
            </div>

            <div class="w-full lg:w-96 flex flex-col gap-4">
                <div class="card p-4 flex-1 overflow-hidden flex flex-col">
                    <h4 class="font-bold mb-4 border-b border-white/10 pb-2">HISTORIAL</h4>
                    <div id="game-history" class="overflow-y-auto flex-1 space-y-3 pr-2 text-sm"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="screen-voting" class="screen justify-center items-center">
        <h2 class="text-4xl font-display font-bold mb-8 text-center">¬øQUI√âN ES EL IMPOSTOR?</h2>
        <div id="voting-grid" class="grid grid-cols-2 md:grid-cols-5 gap-6 mb-8 w-full max-w-5xl"></div>
        <p id="voting-status" class="text-cyan-400 animate-pulse">Las IAs est√°n deliberando...</p>
    </div>

    <div id="screen-result" class="screen justify-center items-center text-center">
        <div id="result-icon" class="text-8xl mb-4">üèÜ</div>
        <h2 id="result-title" class="text-6xl font-black font-display mb-4">VICTORIA</h2>
        <p id="result-detail" class="text-xl text-gray-300 mb-8 max-w-2xl"></p>
        
        <div class="card p-6 mb-8 w-full max-w-md">
            <p class="text-gray-500 text-sm">La palabra secreta era:</p>
            <p id="revealed-word" class="text-4xl font-bold text-cyan-400 mt-2">PIZZA</p>
        </div>

        <button onclick="location.reload()" class="btn btn-primary">JUGAR OTRA VEZ</button>
    </div>

    <script>
        // --- BASE DE DATOS DE PALABRAS ---
        const WORD_DATABASE = [
            { category: "Comida", word: "Pizza", hints: ["queso", "redonda", "italiana", "horno"] },
            { category: "Comida", word: "Sushi", hints: ["arroz", "pescado", "japon√©s", "crudo"] },
            { category: "Animal", word: "Gato", hints: ["maullido", "bigotes", "dom√©stico", "√°gil"] },
            { category: "Animal", word: "Elefante", hints: ["trompa", "grande", "gris", "memoria"] },
            { category: "Profesi√≥n", word: "M√©dico", hints: ["hospital", "bata", "salud", "pacientes"] },
            { category: "Objeto", word: "Tel√©fono", hints: ["llamada", "pantalla", "comunicaci√≥n", "bolsillo"] },
            { category: "Lugar", word: "Playa", hints: ["arena", "mar", "sol", "verano"] },
            { category: "Deporte", word: "F√∫tbol", hints: ["bal√≥n", "gol", "porter√≠a", "once"] }
        ];

        // --- CLASE AGENTE IA (CON API REAL) ---
        class AIAgent {
            constructor(id, role, word, category) {
                this.id = id;
                this.name = `IA-${id}`;
                this.role = role; // 'civil' o 'impostor'
                this.word = word;
                this.category = category;
                this.eliminated = false;
                this.personalities = ["anal√≠tico", "creativo", "paranoico", "breve", "po√©tico"];
                this.personality = this.personalities[Math.floor(Math.random() * this.personalities.length)];
            }

            async generateTurn(history, round) {
                // Construcci√≥n del Prompt para la IA
                const roleInstruction = this.role === 'civil' 
                    ? `Eres un CIUDADANO inocente. Tu palabra secreta es "${this.word}". Describe tu palabra sutilmente para probar que eres inocente, pero no seas tan obvio para que el impostor la adivine. NO digas la palabra "${this.word}" directamente.`
                    : `Eres el IMPOSTOR. No sabes la palabra secreta, solo sabes que la categor√≠a es "${this.category}". Trata de encajar con lo que dicen los dem√°s. S√© ambiguo pero convincente.`;

                const context = `Juego: El Impostor. Ronda ${round}.
                Historial de chat: ${history.map(h => `${h.name}: ${h.text}`).join(' | ')}.
                Tu personalidad es: ${this.personality}.
                Instrucci√≥n: Genera una descripci√≥n de 1 a 3 palabras.
                Responde EXCLUSIVAMENTE en formato JSON: {"text": "tu descripci√≥n"}`;

                try {
                    const response = await this.callPollinationsAPI(roleInstruction + " " + context);
                    return this.parseJSON(response);
                } catch (e) {
                    console.error("Error API:", e);
                    return { text: "..." }; // Fallback
                }
            }

            async vote(players, history) {
                const alivePlayers = players.filter(p => !p.eliminated && p.id !== this.id);
                const candidates = alivePlayers.map(p => `${p.name} (ID:${p.id})`).join(', ');
                
                const prompt = `Eres ${this.role}. Historial: ${history.map(h => `${h.name}: "${h.text}"`).join(' | ')}.
                Jugadores vivos: ${candidates}.
                Analiza qui√©n es sospechoso. Si eres Impostor, vota a un inocente para eliminarlo. Si eres Civil, busca incoherencias.
                Responde SOLO JSON: {"voteId": id_numerico, "reason": "breve raz√≥n"}`;

                try {
                    const response = await this.callPollinationsAPI(prompt);
                    let result = this.parseJSON(response);
                    // Validar voto
                    if (!alivePlayers.find(p => p.id === result.voteId)) {
                         result.voteId = alivePlayers[0].id; // Voto random fallback
                    }
                    return result;
                } catch (e) {
                    return { voteId: alivePlayers[0].id, reason: "Instinto" };
                }
            }

            async callPollinationsAPI(prompt) {
                const response = await fetch('https://text.pollinations.ai/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        messages: [{ role: 'system', content: 'You are a game bot JSON generator.' }, { role: 'user', content: prompt }],
                        model: 'openai', 
                        seed: Math.floor(Math.random() * 100000)
                    })
                });
                return await response.text();
            }

            parseJSON(text) {
                // Limpiador de basura de IA (markdown, texto extra)
                try {
                    const jsonMatch = text.match(/\{[\s\S]*?\}/);
                    if (jsonMatch) return JSON.parse(jsonMatch[0]);
                    return { text: text.substring(0, 20), voteId: 0, reason: "Error parsing" };
                } catch (e) { return { text: "Hmm...", voteId: 0 }; }
            }
        }

        // --- MOTOR DEL JUEGO ---
        const game = {
            players: [],
            round: 1,
            maxRounds: 3,
            history: [],
            isSpectator: false,
            humanPlayerId: null,
            currentTurnIndex: 0,
            secretWordData: null,
            state: 'idle',

            startHumanMode: function() {
                this.isSpectator = false;
                this.initGame();
            },

            startSpectatorMode: function() {
                this.isSpectator = true;
                this.initGame();
            },

            initGame: function() {
                // Configuraci√≥n inicial
                this.secretWordData = WORD_DATABASE[Math.floor(Math.random() * WORD_DATABASE.length)];
                this.players = [];
                this.history = [];
                this.round = 1;
                
                // Asignar roles (1 Impostor, 4 Civiles)
                let roles = ['civil', 'civil', 'civil', 'civil', 'impostor'];
                roles = roles.sort(() => Math.random() - 0.5);

                // Crear jugadores
                for (let i = 0; i < 5; i++) {
                    let p = new AIAgent(i, roles[i], this.secretWordData.word, this.secretWordData.category);
                    if (!this.isSpectator && i === 0) {
                        this.humanPlayerId = 0;
                        p.name = "T√ö"; // Humano
                    }
                    this.players.push(p);
                }

                ui.showScreen('screen-lobby');
                ui.renderLobby(this.players);

                // Simular conexi√≥n
                setTimeout(() => {
                    this.startGameLoop();
                }, 2000);
            },

            startGameLoop: async function() {
                ui.showScreen('screen-game');
                ui.updateRound(this.round);
                
                // Mostrar info secreta al humano
                if (!this.isSpectator) {
                    const human = this.players[0];
                    ui.showSecretInfo(human);
                }

                // Ciclo de turnos
                for (let r = 1; r <= this.maxRounds; r++) {
                    this.round = r;
                    ui.updateRound(r);
                    
                    // Mezclar orden de turno cada ronda
                    let turnOrder = [...this.players].filter(p => !p.eliminated); // .sort(() => Math.random() - 0.5); // Orden fijo para facilitar seguimiento visual por ahora

                    for (const player of turnOrder) {
                        await this.playTurn(player);
                    }
                }

                // Fin de rondas -> Votaci√≥n
                this.startVotingPhase();
            },

            playTurn: async function(player) {
                ui.highlightPlayer(player);
                
                if (player.id === this.humanPlayerId && !this.isSpectator) {
                    // Turno humano
                    return new Promise(resolve => {
                        ui.enableHumanInput(resolve);
                    });
                } else {
                    // Turno IA
                    ui.setTyping(true);
                    const response = await player.generateTurn(this.history, this.round);
                    ui.setTyping(false);
                    
                    if (this.isSpectator) ui.logDebug(player.name, response);
                    
                    this.addHistory(player, response.text);
                    ui.showSpeech(player, response.text);
                    await new Promise(r => setTimeout(r, 2000)); // Pausa para leer
                }
            },

            submitHumanMove: function() {
                const input = document.getElementById('human-input');
                const text = input.value.trim();
                if (!text) return;
                
                const player = this.players[0];
                this.addHistory(player, text);
                ui.showSpeech(player, text);
                ui.disableHumanInput();
                input.value = "";
                
                if (this.humanMoveResolver) {
                    this.humanMoveResolver(); // Continuar loop
                }
            },

            addHistory: function(player, text) {
                this.history.push({ id: player.id, name: player.name, text: text, role: player.role });
                ui.addHistoryItem(player.name, text, player.role, this.isSpectator || player.id === this.humanPlayerId);
            },

            startVotingPhase: async function() {
                ui.showScreen('screen-voting');
                const alive = this.players.filter(p => !p.eliminated);
                ui.renderVotingCards(alive);

                const votes = {}; // id_votado -> cuenta

                // Recoger votos
                for (const p of alive) {
                    if (p.id === this.humanPlayerId && !this.isSpectator) {
                        // Esperar voto humano (click en tarjeta)
                         await new Promise(resolve => { this.votingResolver = resolve; });
                         // Humano ya vot√≥ v√≠a UI
                    } else {
                        const v = await p.vote(this.players, this.history);
                        if(this.isSpectator) ui.logDebug(p.name, `Vota a ${v.voteId} porque: ${v.reason}`);
                        votes[v.voteId] = (votes[v.voteId] || 0) + 1;
                    }
                }

                // Calcular resultado
                let maxVotes = -1;
                let eliminatedId = -1;
                
                // L√≥gica simple de mayor√≠a
                for (const [pid, count] of Object.entries(votes)) {
                    if (count > maxVotes) {
                        maxVotes = count;
                        eliminatedId = parseInt(pid);
                    }
                }

                this.resolveGame(eliminatedId);
            },

            handleHumanVote: function(targetId) {
                if (this.votingResolver) this.votingResolver();
                // Simular l√≥gica de voto humano (simple visual)
            },

            resolveGame: function(eliminatedId) {
                const eliminatedPlayer = this.players.find(p => p.id === eliminatedId);
                const impostor = this.players.find(p => p.role === 'impostor');
                
                let playerWon = false;
                let title = "";
                let desc = "";

                if (eliminatedPlayer.role === 'impostor') {
                    title = "¬°CIVILES GANAN!";
                    desc = `Hab√©is descubierto al impostor (${eliminatedPlayer.name}).`;
                    playerWon = this.humanPlayerId !== null ? (this.players[this.humanPlayerId].role === 'civil') : true;
                } else {
                    title = "¬°IMPOSTOR GANA!";
                    desc = `Expulsasteis a un inocente (${eliminatedPlayer.name}). El impostor era ${impostor.name}.`;
                    playerWon = this.humanPlayerId !== null ? (this.players[this.humanPlayerId].role === 'impostor') : false;
                }

                ui.showResults(title, desc, this.secretWordData.word, playerWon);
            }
        };

        // --- CONTROLADOR UI ---
        const ui = {
            screens: ['screen-start', 'screen-lobby', 'screen-game', 'screen-voting', 'screen-result'],
            
            showScreen: function(id) {
                this.screens.forEach(s => document.getElementById(s).classList.remove('active'));
                document.getElementById(id).classList.add('active');
            },

            renderLobby: function(players) {
                const grid = document.getElementById('lobby-grid');
                grid.innerHTML = players.map(p => `
                    <div class="card p-4 flex flex-col items-center">
                        <div class="avatar ${game.isSpectator ? p.role : (p.id===0 ? p.role : 'unknown')} mb-2">${p.name.substring(0,2)}</div>
                        <div class="font-bold">${p.name}</div>
                        ${game.isSpectator ? `<div class="text-xs text-gray-400">${p.role}</div>` : ''}
                    </div>
                `).join('');
            },

            showSecretInfo: function(player) {
                const container = document.getElementById('secret-info');
                container.classList.remove('hidden');
                document.getElementById('player-role-display').innerText = player.role.toUpperCase();
                document.getElementById('player-role-display').className = `font-bold text-xl mb-2 ${player.role === 'impostor' ? 'text-neon-magenta' : 'text-cyan-400'}`;
                
                // Si es civil ve la palabra, si es impostor ve la categor√≠a
                if (player.role === 'civil') {
                    document.getElementById('player-word-display').innerText = `Palabra: ${player.word}`;
                } else {
                    document.getElementById('player-word-display').innerText = `Categor√≠a: ${player.category}`;
                    document.getElementById('player-word-display').classList.add('text-magenta-500');
                }
            },

            updateRound: function(n) {
                document.getElementById('round-num').innerText = n;
            },

            highlightPlayer: function(player) {
                document.getElementById('main-name').innerText = player.name;
                const avatar = document.getElementById('main-avatar');
                
                // Determinar estilo del avatar visible
                let visibleRole = 'unknown';
                if (game.isSpectator || player.id === game.humanPlayerId) {
                    visibleRole = player.role;
                }

                avatar.className = `avatar ${visibleRole}`;
                avatar.innerText = player.name.substring(0,2);
                document.getElementById('speech-text').innerText = "...";
            },

            setTyping: function(isTyping) {
                document.getElementById('typing-status').style.opacity = isTyping ? 1 : 0;
            },

            showSpeech: function(player, text) {
                document.getElementById('speech-text').innerText = `"${text}"`;
            },

            addHistoryItem: function(name, text, role, revealRole) {
                const div = document.createElement('div');
                const roleColor = role === 'impostor' ? 'text-magenta-500' : 'text-cyan-400';
                // Si no se debe revelar el rol, usar color neutro
                const finalColor = revealRole ? roleColor : 'text-gray-400';
                
                div.innerHTML = `<span class="font-bold ${finalColor}">${name}:</span> <span class="text-gray-300">${text}</span>`;
                div.className = "border-b border-white/5 pb-1";
                document.getElementById('game-history').appendChild(div);
                document.getElementById('game-history').scrollTop = 9999; // Scroll to bottom
            },

            enableHumanInput: function(resolver) {
                game.humanMoveResolver = resolver;
                document.getElementById('human-input-area').classList.remove('hidden');
                document.getElementById('human-input').focus();
            },

            disableHumanInput: function() {
                document.getElementById('human-input-area').classList.add('hidden');
            },

            renderVotingCards: function(players) {
                const grid = document.getElementById('voting-grid');
                grid.innerHTML = players.map(p => `
                    <div onclick="game.handleHumanVote(${p.id})" class="card p-6 flex flex-col items-center cursor-pointer hover:bg-white/10 transition-colors">
                        <div class="avatar ${game.isSpectator ? p.role : 'unknown'} mb-4 text-2xl">${p.name.substring(0,2)}</div>
                        <div class="font-bold text-xl">${p.name}</div>
                        <div class="text-xs mt-2 text-cyan-400 opacity-0 hover:opacity-100">VOTAR</div>
                    </div>
                `).join('');
            },
            
            showResults: function(title, detail, word, won) {
                ui.showScreen('screen-result');
                const tEl = document.getElementById('result-title');
                tEl.innerText = title;
                tEl.style.color = won ? 'var(--color-green)' : 'red';
                document.getElementById('result-detail').innerText = detail;
                document.getElementById('revealed-word').innerText = word;
                document.getElementById('result-icon').innerText = won ? 'üéâ' : 'üíÄ';
            },

            logDebug: function(name, json) {
                if (!game.isSpectator) return;
                document.getElementById('debug-panel').classList.remove('hidden');
                const log = document.getElementById('debug-log');
                const div = document.createElement('div');
                div.className = 'debug-entry';
                div.innerText = `${name}: ${JSON.stringify(json)}`;
                log.appendChild(div);
                log.scrollTop = 9999;
            }
        };
    </script>
</body>
</html>

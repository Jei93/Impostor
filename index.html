<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>THE IMPOSTOR: ULTIMATE EDITION</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --neon-cyan: #00f3ff;
            --neon-pink: #ff0099;
            --neon-green: #00ff66;
            --bg-dark: #0a0a0f;
            --panel-bg: #14141a;
        }
        body { background-color: var(--bg-dark); color: #fff; font-family: 'Montserrat', sans-serif; overflow-x: hidden; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        
        /* Animaciones y Efectos */
        .glow-text { text-shadow: 0 0 10px rgba(0, 243, 255, 0.5); }
        .card { background: var(--panel-bg); border: 1px solid rgba(255,255,255,0.1); transition: all 0.3s ease; }
        .card.active { border-color: var(--neon-cyan); box-shadow: 0 0 20px rgba(0, 243, 255, 0.2); }
        
        /* Chat Bubbles */
        .chat-bubble { max-width: 80%; padding: 12px 16px; border-radius: 12px; margin-bottom: 10px; position: relative; animation: slideIn 0.3s ease; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .bubble-civil { border-left: 3px solid var(--neon-cyan); background: linear-gradient(90deg, rgba(0,243,255,0.05) 0%, transparent 100%); }
        .bubble-impostor { border-left: 3px solid var(--neon-pink); background: linear-gradient(90deg, rgba(255,0,153,0.05) 0%, transparent 100%); }
        
        /* Roles (Solo visibles en espectador/fin) */
        .role-badge { font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; text-transform: uppercase; font-weight: bold; }
        .role-civil { color: var(--neon-cyan); border: 1px solid var(--neon-cyan); }
        .role-impostor { color: var(--neon-pink); border: 1px solid var(--neon-pink); }
        
        .screen { display: none; min-height: 100vh; flex-direction: column; }
        .screen.active { display: flex; }

        /* Loader IA */
        .typing-dot { display: inline-block; width: 6px; height: 6px; background: var(--neon-green); border-radius: 50%; animation: pulse 1s infinite; margin: 0 2px; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes pulse { 0%, 100% { opacity: 0.3; transform: scale(0.8); } 50% { opacity: 1; transform: scale(1.2); } }

        /* Log de Debug */
        #debug-console { font-family: 'JetBrains Mono', monospace; font-size: 10px; color: #888; border-top: 1px solid #333; max-height: 150px; overflow-y: auto; padding: 10px; background: #000; }
        .log-entry { margin-bottom: 4px; border-left: 2px solid #333; padding-left: 5px; }
        .log-success { border-color: var(--neon-green); color: #cfc; }
        .log-error { border-color: var(--neon-pink); color: #fcc; }
    </style>
</head>
<body>

    <div id="screen-menu" class="screen active items-center justify-center p-4 text-center">
        <h1 class="text-6xl md:text-8xl font-black mb-2 tracking-tighter text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-blue-600 glow-text">THE IMPOSTOR</h1>
        <p class="text-gray-400 mb-12 font-mono text-sm">IA REAL ‚Ä¢ DEBATE EN VIVO ‚Ä¢ SIN GUIONES</p>
        
        <div class="flex flex-col md:flex-row gap-6 w-full max-w-2xl z-10">
            <button onclick="Game.init(false)" class="flex-1 bg-white text-black font-bold py-6 px-8 rounded-xl hover:scale-105 transition-transform border-2 border-transparent hover:border-cyan-400 shadow-lg">
                üéÆ JUGAR COMO HUMANO
            </button>
            <button onclick="Game.init(true)" class="flex-1 bg-transparent text-white font-bold py-6 px-8 rounded-xl border-2 border-gray-600 hover:border-pink-500 hover:text-pink-400 hover:scale-105 transition-all">
                üëÅÔ∏è MODO ESPECTADOR
            </button>
        </div>
        <div class="mt-8 text-xs text-gray-600 max-w-md">
            Nota: Este juego conecta con APIs de IA en tiempo real. Si las respuestas tardan, es porque est√°n "pensando".
        </div>
    </div>

    <div id="screen-game" class="screen">
        <div class="flex justify-between items-center p-4 border-b border-gray-800 bg-black/50 backdrop-blur-md sticky top-0 z-20">
            <div class="flex items-center gap-4">
                <div class="text-xs font-mono text-gray-400">RONDA <span id="round-idx" class="text-white text-xl font-bold">1</span>/3</div>
                <div id="status-indicator" class="px-3 py-1 rounded-full bg-green-900/30 text-green-400 text-xs border border-green-800 flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span> ONLINE
                </div>
            </div>
            
            <div id="secret-container" class="text-center hidden">
                <div class="text-[10px] text-gray-500 uppercase tracking-widest">PALABRA SECRETA</div>
                <div id="secret-word" class="text-2xl font-black text-cyan-400 glow-text">???</div>
                <div id="secret-hint" class="text-xs text-pink-400 hidden"></div>
            </div>
        </div>

        <div class="flex flex-col lg:flex-row flex-1 overflow-hidden">
            <div class="flex-1 flex flex-col p-4 overflow-hidden relative">
                <div id="chat-container" class="flex-1 overflow-y-auto space-y-4 pb-20 pr-2 scroll-smooth">
                    <div class="text-center text-gray-600 text-sm mt-10 italic">Iniciando conexi√≥n neuronal...</div>
                </div>

                <div id="human-controls" class="absolute bottom-0 left-0 w-full p-4 bg-gradient-to-t from-black via-black to-transparent hidden">
                    <div class="max-w-3xl mx-auto flex gap-2">
                        <input type="text" id="human-input" class="flex-1 bg-gray-900 border border-gray-700 text-white rounded-lg px-4 py-3 focus:outline-none focus:border-cyan-500 transition-colors" placeholder="Escribe tu pista (1 sola palabra)..." maxlength="20" autocomplete="off">
                        <button onclick="Game.handleHumanInput()" class="bg-cyan-600 hover:bg-cyan-500 text-white font-bold px-6 py-3 rounded-lg shadow-lg shadow-cyan-900/20">ENVIAR</button>
                    </div>
                </div>
            </div>

            <div class="w-full lg:w-80 bg-panel-bg border-l border-gray-800 p-4 flex flex-col gap-4 overflow-y-auto">
                <h3 class="text-xs font-bold text-gray-500 uppercase tracking-wider">JUGADORES</h3>
                <div id="players-list" class="flex flex-col gap-3">
                    </div>
                
                <div class="mt-auto">
                    <h3 class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-2">DEBUG DE PENSAMIENTOS</h3>
                    <div id="debug-console"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="screen-voting" class="screen items-center justify-center p-6 text-center">
        <h2 class="text-4xl font-bold mb-2">FASE DE VOTACI√ìN</h2>
        <p class="text-gray-400 mb-8">Selecciona al jugador sospechoso</p>
        
        <div id="voting-grid" class="grid grid-cols-2 md:grid-cols-5 gap-4 w-full max-w-4xl">
            </div>
        
        <div id="voting-log" class="mt-8 text-sm font-mono text-left w-full max-w-2xl bg-black/50 p-4 rounded-lg h-40 overflow-y-auto hidden"></div>
    </div>

    <div id="screen-result" class="screen items-center justify-center p-6 text-center">
        <div id="result-icon" class="text-8xl mb-6">üèÜ</div>
        <h1 id="result-title" class="text-5xl md:text-7xl font-black mb-4">VICTORIA</h1>
        <p id="result-msg" class="text-xl text-gray-300 mb-8 max-w-2xl mx-auto"></p>
        
        <div class="bg-white/5 border border-white/10 p-6 rounded-xl mb-8 w-full max-w-md">
            <div class="text-sm text-gray-500 uppercase mb-2">La palabra era</div>
            <div id="result-word" class="text-4xl font-bold text-cyan-400">???</div>
            <div id="result-impostor" class="mt-4 text-pink-400 font-mono text-sm"></div>
        </div>

        <button onclick="location.reload()" class="bg-white text-black font-bold py-3 px-8 rounded-full hover:bg-gray-200 transition-colors">
            JUGAR OTRA VEZ
        </button>
    </div>

    <script>
        // --- BASE DE DATOS MEJORADA ---
        const DB = [
            { cat: "Playa", word: "Arena", hints: ["mar", "castillo", "toalla", "sol"] },
            { cat: "Cocina", word: "Sart√©n", hints: ["aceite", "huevo", "mango", "fuego"] },
            { cat: "Cuerpo", word: "Ojo", hints: ["ver", "gafas", "color", "pesta√±a"] },
            { cat: "Clima", word: "Lluvia", hints: ["agua", "nube", "paraguas", "mojado"] },
            { cat: "Escuela", word: "L√°piz", hints: ["escribir", "goma", "papel", "dibujo"] },
            { cat: "Cielo", word: "Luna", hints: ["noche", "blanca", "lobo", "cr√°ter"] },
            { cat: "Ropa", word: "Calcet√≠n", hints: ["pie", "zapato", "lana", "par"] }
        ];

        // --- SISTEMA DE API ROBUSTO ---
        const AI = {
            async generate(prompt, retries = 2) {
                // Encodeamos correctamente para evitar errores de URL
                const safePrompt = encodeURIComponent(prompt);
                // Usamos un seed aleatorio para evitar cach√© de la API
                const seed = Math.floor(Math.random() * 999999);
                const url = `https://text.pollinations.ai/${safePrompt}?seed=${seed}&model=openai`;

                try {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 8000); // 8 segundos timeout

                    const response = await fetch(url, { 
                        method: 'GET',
                        signal: controller.signal
                    });
                    
                    clearTimeout(timeoutId);

                    if (!response.ok) throw new Error(`API ${response.status}`);
                    
                    let text = await response.text();
                    return this.cleanText(text);

                } catch (e) {
                    console.error("AI Error:", e);
                    if (retries > 0) {
                        UI.logDebug(`Reintentando conexi√≥n IA... (${retries})`, false);
                        await new Promise(r => setTimeout(r, 1500));
                        return this.generate(prompt, retries - 1);
                    }
                    return null; // Fall√≥ totalmente
                }
            },

            cleanText(text) {
                // Limpieza agresiva para evitar "Hola, soy una IA..."
                // 1. Quitar comillas y JSON
                let clean = text.replace(/["'{}]/g, '');
                // 2. Quitar prefijos comunes de IAs parlanchinas
                clean = clean.replace(/^(La palabra es|Mi pista es|Yo digo|Pista:|Respuesta:)/i, '');
                // 3. Quitar explicaciones despu√©s de un punto
                clean = clean.split('.')[0];
                clean = clean.split('\n')[0];
                // 4. Recortar espacios
                return clean.trim();
            }
        };

        // --- CLASE JUGADOR ---
        class Player {
            constructor(id, name, isHuman, role) {
                this.id = id;
                this.name = name;
                this.isHuman = isHuman;
                this.role = role; // 'civil' | 'impostor'
                this.eliminated = false;
                this.avatarColor = `hsl(${Math.random() * 360}, 70%, 50%)`;
                this.modelName = isHuman ? "Cerebro Humano" : ["GPT-4", "Claude-3", "Llama-3", "Mistral"][Math.floor(Math.random()*4)];
            }

            async playTurn(round, history, secretData) {
                if (this.isHuman) {
                    return new Promise(resolve => Game.humanResolve = resolve);
                }

                // INGENIER√çA DE PROMPTS AVANZADA
                let systemPrompt = "";
                const historyText = history.map(h => `[${h.player}]: ${h.text}`).join(" | ");
                
                if (this.role === 'civil') {
                    systemPrompt = `Est√°s jugando a 'El Impostor'. Tu palabra secreta es "${secretData.word}".
                    OBJETIVO: Da una pista de UNA SOLA PALABRA relacionada con "${secretData.word}".
                    REGLAS:
                    1. NO uses la palabra "${secretData.word}" ni sus derivadas.
                    2. S√© astuto: Si la palabra es "Sol", no digas "Calor", di "Gafas" o "Verano".
                    3. No repitas palabras dichas en el historial: ${historyText}.
                    4. Responde SOLAMENTE con tu palabra pista. Nada m√°s.`;
                } else {
                    systemPrompt = `Est√°s jugando a 'El Impostor'. Eres el IMPOSTOR.
                    INFORMACI√ìN: No sabes la palabra secreta. La categor√≠a es "${secretData.cat}".
                    OBJETIVO: Pasa desapercibido.
                    REGLAS:
                    1. Lee el historial: ${historyText}.
                    2. Deduce el contexto y di una palabra que encaje vagamente con la categor√≠a "${secretData.cat}" y con lo que han dicho los otros.
                    3. Si no hay historial, di algo gen√©rico sobre "${secretData.cat}".
                    4. Responde SOLAMENTE con tu palabra pista. Nada m√°s.`;
                }

                const response = await AI.generate(systemPrompt);
                
                // Si la IA falla totalmente (API down), usamos un fallback interno
                if (!response) {
                    const fallbacks = ["Interesante", "Dudoso", "Posible", "Quiz√°s", "Mmm"];
                    return fallbacks[Math.floor(Math.random() * fallbacks.length)];
                }
                
                return response;
            }

            async vote(players, history) {
                if (this.isHuman) return null; // El humano vota por UI

                // Prompt de votaci√≥n
                const candidates = players.filter(p => p.id !== this.id && !p.eliminated);
                const candidatesList = candidates.map(p => `${p.name} (ID: ${p.id})`).join(", ");
                const historyText = history.map(h => `[${h.player}]: ${h.text}`).join("\n");

                const prompt = `Analiza este juego de 'El Impostor'.
                Historial del chat:
                ${historyText}
                
                Jugadores vivos: ${candidatesList}.
                
                Tu rol: ${this.role}.
                TAREA: ¬øQui√©n es el m√°s sospechoso (impostor) o a qui√©n quieres eliminar?
                Responde SOLAMENTE con el ID num√©rico del jugador que votas. Ejemplo: "2"`;

                const vote = await AI.generate(prompt);
                // Extraer solo el n√∫mero
                const targetId = parseInt(vote.replace(/\D/g, ''));
                
                // Validar voto
                const target = candidates.find(p => p.id === targetId);
                return target ? target.id : candidates[0].id; // Fallback al primero si la IA alucina
            }
        }

        // --- MOTOR DEL JUEGO ---
        const Game = {
            players: [],
            history: [],
            round: 1,
            maxRounds: 3,
            secretData: null,
            isSpectator: false,
            humanResolve: null,
            turnIdx: 0,

            init(spectatorMode) {
                this.isSpectator = spectatorMode;
                this.secretData = DB[Math.floor(Math.random() * DB.length)];
                this.history = [];
                this.round = 1;
                this.players = [];

                // Crear 5 jugadores
                const names = ["Alpha", "Beta", "Gamma", "Delta", "Omega"];
                let roles = ["civil", "civil", "civil", "civil", "impostor"].sort(() => Math.random() - 0.5);

                for (let i = 0; i < 5; i++) {
                    const isHuman = (!spectatorMode && i === 0);
                    const name = isHuman ? "T√ö" : names[i];
                    this.players.push(new Player(i, name, isHuman, roles[i]));
                }

                UI.setupGameScreen();
                this.runGameLoop();
            },

            async runGameLoop() {
                UI.showScreen('screen-game');
                UI.updateSecretInfo();
                UI.renderPlayers();

                for (let r = 1; r <= this.maxRounds; r++) {
                    this.round = r;
                    document.getElementById('round-idx').textContent = r;
                    UI.addSystemMessage(`--- INICIO RONDA ${r} ---`);

                    // Mezclar orden ligeramente para variar (pero mantener humano primero si es jugador para UX)
                    let turnOrder = [...this.players].filter(p => !p.eliminated);
                    if (this.isSpectator) turnOrder.sort(() => Math.random() - 0.5);

                    for (const player of turnOrder) {
                        UI.highlightPlayer(player.id);
                        
                        // "Pensando..."
                        if (!player.isHuman) {
                            UI.setTyping(player.id, true);
                            await new Promise(res => setTimeout(res, Math.random() * 2000 + 1000)); // Delay "humano"
                        } else {
                            UI.enableHumanInput(true);
                        }

                        // Generar turno
                        const text = await player.playTurn(this.round, this.history, this.secretData);
                        
                        // Post-turno
                        UI.setTyping(player.id, false);
                        UI.enableHumanInput(false);
                        
                        if (player.isHuman && !text) continue; // Manejo de error

                        // Registrar y mostrar
                        this.history.push({ player: player.name, text: text, role: player.role });
                        UI.addChatMessage(player, text);
                        
                        if (this.isSpectator) UI.logDebug(`${player.name} (${player.role}): "${text}"`, true);

                        await new Promise(res => setTimeout(res, 1000)); // Pausa lectura
                    }
                }

                this.startVoting();
            },

            handleHumanInput() {
                const input = document.getElementById('human-input');
                const val = input.value.trim();
                if (val && this.humanResolve) {
                    this.humanResolve(val);
                    input.value = "";
                }
            },

            async startVoting() {
                UI.showScreen('screen-voting');
                const container = document.getElementById('voting-grid');
                container.innerHTML = '';
                const alive = this.players.filter(p => !p.eliminated);
                
                // Crear tarjetas de votaci√≥n
                alive.forEach(p => {
                    const btn = document.createElement('div');
                    btn.className = `bg-gray-800 p-6 rounded-xl cursor-pointer hover:bg-gray-700 hover:border-cyan-500 border-2 border-transparent transition-all flex flex-col items-center gap-2`;
                    btn.innerHTML = `<div class="text-3xl font-bold" style="color:${p.avatarColor}">${p.name.charAt(0)}</div><div class="font-bold">${p.name}</div>`;
                    
                    if (!this.isSpectator && this.players[0].id === p.id) {
                        btn.style.opacity = "0.5"; // No te puedes votar a ti mismo (visual)
                        btn.style.cursor = "not-allowed";
                    } else {
                        btn.onclick = () => this.resolveVoting(p.id);
                    }
                    container.appendChild(btn);
                });

                if (this.isSpectator) {
                    // Simular votaci√≥n autom√°tica tras unos segundos
                    UI.logVoting("Las IAs est√°n deliberando...");
                    await new Promise(r => setTimeout(r, 3000));
                    this.resolveVoting(null); // Null dispara votaci√≥n IA autom√°tica
                } else {
                    UI.logVoting("Selecciona al impostor para votar.");
                }
            },

            async resolveVoting(humanVoteId) {
                const alive = this.players.filter(p => !p.eliminated);
                const votes = {};

                // Recoger votos
                for (const p of alive) {
                    let votedId;
                    if (p.isHuman) {
                        votedId = humanVoteId;
                    } else {
                        votedId = await p.vote(this.players, this.history);
                    }
                    
                    votes[votedId] = (votes[votedId] || 0) + 1;
                    const targetName = this.players.find(pl => pl.id === votedId)?.name || "Nadie";
                    UI.logVoting(`${p.name} vot√≥ a ${targetName}`);
                }

                // Calcular eliminado
                let maxVotes = 0;
                let eliminatedId = null;
                Object.entries(votes).forEach(([id, count]) => {
                    if (count > maxVotes) {
                        maxVotes = count;
                        eliminatedId = parseInt(id);
                    }
                });

                this.endGame(eliminatedId);
            },

            endGame(eliminatedId) {
                const eliminated = this.players.find(p => p.id === eliminatedId);
                const impostor = this.players.find(p => p.role === 'impostor');
                
                UI.showScreen('screen-result');
                
                const title = document.getElementById('result-title');
                const msg = document.getElementById('result-msg');
                const icon = document.getElementById('result-icon');
                
                const impostorEliminated = eliminated && eliminated.role === 'impostor';
                const playerWon = this.isSpectator ? impostorEliminated : (this.players[0].role === 'civil' ? impostorEliminated : !impostorEliminated);

                if (impostorEliminated) {
                    title.innerText = "¬°IMPOSTOR CAZADO!";
                    title.className = "text-5xl md:text-7xl font-black mb-4 text-green-500 glow-text";
                    msg.innerText = `${eliminated.name} era el impostor. ¬°Los civiles ganan!`;
                    icon.innerText = "üëÆ";
                } else {
                    title.innerText = "EL IMPOSTOR GANA";
                    title.className = "text-5xl md:text-7xl font-black mb-4 text-pink-500 glow-text";
                    msg.innerText = `Eliminasteis a ${eliminated ? eliminated.name : 'nadie'} (Inocente). El impostor era ${impostor.name}.`;
                    icon.innerText = "üî™";
                }

                document.getElementById('result-word').innerText = this.secretData.word;
                document.getElementById('result-impostor').innerText = `Impostor: ${impostor.name} (ID: ${impostor.id})`;
            }
        };

        // --- GESTOR DE UI ---
        const UI = {
            setupGameScreen() {
                document.getElementById('chat-container').innerHTML = '';
                document.getElementById('debug-console').innerHTML = '';
            },

            showScreen(id) {
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                document.getElementById(id).classList.add('active');
            },

            updateSecretInfo() {
                const isCivil = (!Game.isSpectator && Game.players[0].role === 'civil');
                const isImpostor = (!Game.isSpectator && Game.players[0].role === 'impostor');
                const container = document.getElementById('secret-container');
                const wordEl = document.getElementById('secret-word');
                const hintEl = document.getElementById('secret-hint');

                if (Game.isSpectator || isCivil) {
                    container.classList.remove('hidden');
                    wordEl.textContent = Game.secretData.word;
                    wordEl.className = "text-2xl font-black text-cyan-400 glow-text";
                    hintEl.classList.remove('hidden');
                    hintEl.textContent = `Categor√≠a: ${Game.secretData.cat}`;
                } else if (isImpostor) {
                    container.classList.remove('hidden');
                    wordEl.textContent = "???";
                    wordEl.className = "text-2xl font-black text-red-500 glow-text";
                    hintEl.classList.remove('hidden');
                    hintEl.textContent = `Eres IMPOSTOR. Cat: ${Game.secretData.cat}`;
                }
            },

            renderPlayers() {
                const list = document.getElementById('players-list');
                list.innerHTML = Game.players.map(p => `
                    <div id="p-card-${p.id}" class="bg-gray-900/50 border border-gray-700 rounded-lg p-3 flex items-center gap-3 transition-all">
                        <div class="w-10 h-10 rounded-full flex items-center justify-center font-bold text-black" style="background-color: ${p.avatarColor}">
                            ${p.name.charAt(0)}
                        </div>
                        <div class="flex-1">
                            <div class="text-sm font-bold text-white flex justify-between">
                                ${p.name}
                                ${Game.isSpectator ? `<span class="role-badge ${p.role === 'impostor' ? 'role-impostor' : 'role-civil'}">${p.role}</span>` : ''}
                            </div>
                            <div class="text-[10px] text-gray-500">${p.modelName}</div>
                            <div id="typing-${p.id}" class="h-2 mt-1 hidden">
                                <span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span>
                            </div>
                        </div>
                    </div>
                `).join('');
            },

            highlightPlayer(id) {
                document.querySelectorAll('[id^="p-card-"]').forEach(el => {
                    el.classList.remove('border-cyan-500', 'bg-gray-800');
                    el.style.transform = "scale(1)";
                });
                const card = document.getElementById(`p-card-${id}`);
                if (card) {
                    card.classList.add('border-cyan-500', 'bg-gray-800');
                    card.style.transform = "scale(1.02)";
                    card.scrollIntoView({ behavior: "smooth", block: "nearest" });
                }
            },

            setTyping(id, state) {
                const el = document.getElementById(`typing-${id}`);
                if (el) state ? el.classList.remove('hidden') : el.classList.add('hidden');
            },

            addChatMessage(player, text) {
                const container = document.getElementById('chat-container');
                const isSelf = (!Game.isSpectator && player.id === 0);
                
                // Determinar estilo de burbuja (solo espectador ve colores de rol)
                let bubbleClass = "bg-gray-800";
                if (Game.isSpectator) {
                    bubbleClass = player.role === 'impostor' ? 'bubble-impostor' : 'bubble-civil';
                } else if (isSelf) {
                    bubbleClass = "bg-cyan-900/40 border border-cyan-700";
                }

                const div = document.createElement('div');
                div.className = `flex flex-col ${isSelf ? 'items-end' : 'items-start'} mb-4`;
                div.innerHTML = `
                    <div class="text-[10px] text-gray-400 mb-1 ml-1">${player.name}</div>
                    <div class="chat-bubble ${bubbleClass} text-sm md:text-base">
                        ${text}
                    </div>
                `;
                container.appendChild(div);
                container.scrollTop = container.scrollHeight;
            },

            addSystemMessage(text) {
                const container = document.getElementById('chat-container');
                container.innerHTML += `<div class="text-center text-[10px] font-mono text-gray-600 my-4 uppercase tracking-widest">${text}</div>`;
            },

            enableHumanInput(enable) {
                const controls = document.getElementById('human-controls');
                if (enable) {
                    controls.classList.remove('hidden');
                    document.getElementById('human-input').focus();
                } else {
                    controls.classList.add('hidden');
                }
            },

            logDebug(msg, success) {
                const consoleEl = document.getElementById('debug-console');
                const entry = document.createElement('div');
                entry.className = `log-entry ${success ? 'log-success' : 'log-error'}`;
                entry.textContent = `> ${msg}`;
                consoleEl.appendChild(entry);
                consoleEl.scrollTop = consoleEl.scrollHeight;
            },

            logVoting(msg) {
                const log = document.getElementById('voting-log');
                log.classList.remove('hidden');
                log.innerHTML += `<div>> ${msg}</div>`;
                log.scrollTop = log.scrollHeight;
            }
        };
    </script>
</body>
</html>
